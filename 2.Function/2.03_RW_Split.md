## 2.3 读写分离
3.20.10.0版本dble支持单纯的读写分离，可以和分库分表功能分开单独使用。原先的版本分库分表也支持读写分离，不影响该功能的使用。

### 2.3.1 读写分离配置

若想启用dble的读写分离，仅需在 user.xml 文件中配置 rwSplitUser并指定对应的dbGroup即可。dbGroup的配置参考db.xml的章节配置。这里需要注意的是三种用户配置的顺序是固定的。user.xml的详细配置请参考配置一章。
```xml
<dble:user xmlns:dble="http://dble.cloud/" version="4.0">
    <managerUser name="man1" password="654321" maxCon="100"/>
    <shardingUser name="root" password="123456" schemas="testdb" readOnly="false" maxCon="20"/>
    <rwSplitUser name="rwsu1" password="123456" dbGroup="rwGroup" maxCon="20"/>
</dble:user>
```

#### 2.3.1.1 配置注意事项
1. 当在user.xml中仅配置rwSplitUser时，dble不会加载sharding.xml的相关内容，即dble不具备分库分表的功能。  
2. 当同时开启dble读写分离和分库分表的功能，分库分表引用的dbGroup和读写分离引用的dbGroup必须相互独立。rwSplitUser引用的dbGroup，仅需在db.xml中定义即可。shardingUser引用的dbGroup，需要被配置的schemas对应的sharding.xml中的shardingNode所引用。
3. 多个rwSplitUser可以引用同一个dbGroup。
4. 被读写分离或者分库分表使用的dbGroup内的instance才会有心跳和连接池；未被有效使用的dbGroup内的instance只有心跳，不会初始化连接池。

#### 2.3.1.2 功能限制
1. druid 解析器限制 - 不支持set语句中存在特殊字符；
2. druid 解析器限制 - set session transaction read write, isolation level repeatable read中，逗号后的语句不生效；
2. 只读事务的支持；
3. 不支持set transaction read write；
4. select 语句现在的逻辑是都进行负载，还没有进行细节的区分，比如有些语句需要强制发主，如系统函数，系统表，系统变量；
5. select ... into或者load data中存在用户变量，通过dble再次查询该变量，变量值不对；
6. 临时表，预编译语句和当前连接存在关联，使用会有问题；
7. client连接dble时，若指定不存在的schema默认库，dble不会报错；
8. 在会话中，删除正在使用的库，mysql会将当前库置为null，dble依然保留；


### 2.3.2 读写分离条件

要实现读写分离必须满足如下条件：

1. 必须在db.xml中配置多个dbInstance(参见db.xml章节) 而且rwSplitMode配置不为0。 
2. SQL语句为select 或者show。  
3. 在非事务中。  
   当然，也可以通过注释/*#dble:db_type=slave, ... */ 或者/*!dble:db_type=slave, ... */ 强制发从(参见2.4 Hint).

 
### 2.3.2 负载均衡

dble通过配置多个dbInstance为读操作提供负载均衡。负载均衡通过如下的连接获取来实现。连接获取有如下两个步骤：

1.参与读写分离的资格检查，确定符合参与读写分离的候选主机集合
2.参与者承担读任务的负载均衡算法

#### 2.3.2.1  参与读写分离的资格检查

该算法在每次连接获取时提供可用的mysql实例集.

+ 写节点(primary="true")正常(heartbeat状态正常)
  - 写节点参与均衡,则有资格参与读写分离中的读,加入候选主机集合
  - 读节点(primary没配置或者 primary="false" )
     + 节点正常且需要同步状态检测,检查同步状态确定资格，决定是否加入候选主机集合
     + 节点正常且不需要同步状态检测,直接符合资格,加入候选主机集合
+ 写节点异常
  - 检查读节点是否可用,决定加入候选主机集合
  
#### 2.3.2.2  负载均衡算法

该算法在候选主机集中选择一个mysql实例以便获取连接.

+ 候选主机集为空,选择当前写主机.
+ 候选主机集为非空
  - 有权重设置(readWeight参数), 但不是所有权重等值, 依权重随机选择.
  - 无权重设置或所有权重等值, 等权随机选择。此种情况指示上面情况的特例。

#### 2.3.2.3 写节点是否参与均衡与dbGroup的rwSplitMode属性有关，具体见下见下图

![rwSplitMode](pic/2.3_rwSplitMode.png)

